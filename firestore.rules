rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isShortString(value, maxLen) {
      return value is string && value.size() <= maxLen;
    }

    function isScore(value) {
      return value is number && value >= 0 && value <= 100;
    }

    function isNonNegativeInt(value) {
      return value is number && value >= 0 && value == value.floor();
    }

    function hasValidVerdict(value) {
      return value == null ||
        value in ['Likely AI-generated', 'Possibly AI-assisted', 'Likely human-authored'];
    }

    function isValidIndicators(value) {
      return value == null || (value is list && value.size() <= 6);
    }

    function isValidAiDetection(value) {
      return value == null || (
        value is map &&
        (!('verdict' in value) || hasValidVerdict(value.verdict)) &&
        (!('likelihoodScore' in value) || isScore(value.likelihoodScore)) &&
        (!('confidence' in value) || isScore(value.confidence)) &&
        (!('rationale' in value) || isShortString(value.rationale, 2000)) &&
        (!('indicators' in value) || isValidIndicators(value.indicators))
      );
    }

    function isValidCommunityDoc(data) {
      return data.keys().hasOnly([
        'headline',
        'summary',
        'credibilityScore',
        'aiVerdict',
        'aiDetection',
        'timestamp',
        'supportCount',
        'disputeCount',
        'userVotes'
      ]) &&
      ('headline' in data && isShortString(data.headline, 512)) &&
      ('summary' in data && isShortString(data.summary, 5000)) &&
      ('credibilityScore' in data && isScore(data.credibilityScore)) &&
      (!('aiVerdict' in data) || hasValidVerdict(data.aiVerdict)) &&
      (!('aiDetection' in data) || isValidAiDetection(data.aiDetection)) &&
      (!('timestamp' in data) || data.timestamp is timestamp) &&
      (!('supportCount' in data) || isNonNegativeInt(data.supportCount)) &&
      (!('disputeCount' in data) || isNonNegativeInt(data.disputeCount)) &&
      (!('userVotes' in data) || data.userVotes is map);
    }

    match /communityFeed/{entryId} {
      allow read: if isSignedIn();

      // Allow creating new community entries
      allow create: if isSignedIn() &&
                    isValidCommunityDoc(request.resource.data) &&
                    request.resource.data.supportCount == 0 &&
                    request.resource.data.disputeCount == 0;

      // Temporary: Allow all updates for authenticated users (for debugging)
      allow update: if isSignedIn();

      allow delete: if false; // No deletion of main community feed entries
    }

    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == userId;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
